<!-- templates/files/index.html - Home page listing uploaded files -->
<!doctype html>
<!-- Use the HTML5 doctype declaration -->
<html lang="en">
<!-- Root HTML element with language attribute -->
<head>
    <!-- Head contains metadata and linked styles/scripts -->
    <meta charset="utf-8">
    <!-- Character encoding for the document -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Responsive viewport tag for mobile scaling -->
    <title>Files Home</title>
    <!-- Page title shown in the browser tab -->
    <!-- Bootstrap CSS via CDN for quick styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Project-specific styles -->
    <link rel="stylesheet" href="/static/files/style.css">
    <link rel="icon" href="/static/files/miningg.jpg" type="image/jpeg">
    <!-- Link to the static CSS file placed in static/files/ -->
</head>
<body>
    <!-- Responsive navigation bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">FileShare</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="/admin/">Admin</a>
        </li>
      </ul>
      <form class="d-flex ms-auto d-none d-lg-flex" role="search">
        <input id="searchTop" class="form-control form-control-sm" type="search" placeholder="Search files" aria-label="Search">
      </form>
      <!-- Fourah Bay College text (added per request) -->
      <div class="d-none d-lg-flex flex-column ms-3 text-end">
        <div class="navbar-text text-white fw-semibold">Fourah Bay College</div>
        <div class="navbar-text text-white-50 small">Mining Department</div>
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">
    <!-- Main content area -->
    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
      {% endfor %}
    {% endif %}
    <section class="hero py-4 mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="hero-title">Explore shared resources</h1>
          <p class="lead text-muted">Notes, past papers and assignments — filtered by level and category.</p>
          {% if user.is_authenticated %}
            <div class="mt-3">
              <div class="p-3 bg-primary text-white rounded-3 shadow-sm">
                <h2 class="mb-0">Welcome back, <span class="fw-bold">{{ user.username }}</span>!</h2>
                <div class="small opacity-75">Glad to see you — explore the latest uploads below.</div>
              </div>
            </div>
          {% endif %}
        </div>
        <div class="ms-3 d-none d-md-block">
          <a class="btn btn-outline-secondary me-2" href="/admin/">Admin</a>
          <a class="btn btn-primary" href="{% url 'files:home' %}">My Files</a>
        </div>
      </div>
    </section>

    <div class="mb-3 controls">
      <div class="row g-2 align-items-center">
        <div class="col-md-6 d-flex align-items-center gap-2">
          <label for="levelFilter" class="visually-hidden">Level</label>
          <select id="levelFilter" class="form-select form-select-sm" style="max-width:140px;">
            <option value="">All levels</option>
            {% for lvl in levels %}
              <option value="{{ lvl }}" {% if current_level == lvl %}selected{% endif %}>Level {{ lvl }}</option>
            {% endfor %}
          </select>

          <label for="categoryFilter" class="visually-hidden">Category</label>
          <select id="categoryFilter" class="form-select form-select-sm" style="max-width:180px;">
            <option value="">All categories</option>
            {% for cat in categories %}
              <option value="{{ cat.key }}" {% if current_category == cat.key %}selected{% endif %}>{{ cat.label }}</option>
            {% endfor %}
          </select>

          <label for="semesterFilter" class="visually-hidden">Semester</label>
          <select id="semesterFilter" class="form-select form-select-sm" style="max-width:160px;">
            <option value="">All semesters</option>
            {% for sem in semesters %}
              <option value="{{ sem.key }}" {% if current_semester == sem.key %}selected{% endif %}>{{ sem.label }}</option>
            {% endfor %}
          </select>

          <button id="resetFilters" class="btn btn-sm btn-outline-secondary">Reset</button>
        </div>
        <div class="col-md-6 text-md-end">
          <input id="searchBox" class="form-control form-control-sm d-inline-block search-input" placeholder="Search files by title..." />
        </div>
      </div>
    </div>

    {% comment %} Grid of file cards. We'll make them filterable client-side using search. {% endcomment %}
    {% if files_groups %}
      <div id="filesGrid">
        {% for date_key, group in files_groups.items %}
          <div class="mb-4">
            <h5 class="mb-2">{{ date_key }}</h5>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
              {% for f in group %}
                <div class="col file-card" data-title="{{ f.title|lower }}" data-level="{{ f.level }}" data-category="{{ f.category }}" data-semester="{{ f.semester }}">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                      <div class="d-flex align-items-start gap-3">
                        <div class="icon-box">{{ f.category|slice:":1"|upper }}</div>
                        <div class="flex-grow-1">
                          <h5 class="card-title mb-1">{{ f.title }}</h5>
<<<<<<< HEAD
                          <div class="meta text-muted small">Level {{ f.level }} • Semester {{ f.semester }} • {{ f.category|title }} • {{ f.file_type|upper }} • {{ f.file_size_display }} • Downloads: {{ f.download_count }}{% if f.uploaded_by %} • Uploaded by: {{ f.uploaded_by.get_full_name|default:f.uploaded_by.username }}{% else %} • Uploaded by: Admin{% endif %}</div>
=======
                          <div class="meta text-muted small">Level {{ f.level }} • Semester {{ f.semester }} • {{ f.category|title }} • {{ f.file_type|upper }} • {{ f.file_size_display }} • Downloads: {{ f.download_count }}</div>
>>>>>>> 851f815b28aefb73556c1cedd85f9d3afbb11056
                        </div>
                      </div>
                      <p class="mt-3 mb-0 text-truncate">Uploaded: {{ f.uploaded_at }}</p>
                      <div class="mt-3 d-flex justify-content-between align-items-center">
                        <a class="btn btn-sm btn-outline-primary" href="{% url 'files:download' f.pk %}">Download</a>
                        <button type="button" class="btn btn-sm btn-secondary preview-btn" data-preview-url="{% url 'files:preview_page' f.pk %}" data-preview-page-url="{% url 'files:preview_page' f.pk %}" data-title="{{ f.title|escape }}">Preview</button>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
    <div class="empty-state text-center py-5">
      <h4>No files yet</h4>
      <p class="text-muted">Uploads will appear here when an admin adds them.</p>
    </div>
    {% endif %}

    <script>
      // Combined client-side filtering: search + level + category
      (function(){
        const search = document.getElementById('searchBox');
        const levelSel = document.getElementById('levelFilter');
        const catSel = document.getElementById('categoryFilter');
        const semesterSel = document.getElementById('semesterFilter');
        const resetBtn = document.getElementById('resetFilters');
        const grid = document.getElementById('filesGrid');
        if (!grid) return;

        function filterCards(){
          const q = (search && search.value.trim().toLowerCase()) || '';
          const lvl = (levelSel && levelSel.value) || '';
          const cat = (catSel && catSel.value) || '';
          const sem = (semesterSel && semesterSel.value) || '';
          const cards = grid.querySelectorAll('.file-card');
          cards.forEach(function(card){
            const title = (card.getAttribute('data-title') || '').toLowerCase();
            const cardLvl = String(card.getAttribute('data-level') || '');
            const cardCat = (card.getAttribute('data-category') || '').toLowerCase();
            const cardSem = String(card.getAttribute('data-semester') || '');

            const matchTitle = q === '' || title.indexOf(q) !== -1;
            const matchLevel = lvl === '' || cardLvl === String(lvl);
            const matchCat = cat === '' || cardCat === String(cat).toLowerCase();
            const matchSem = sem === '' || cardSem === String(sem);

            const show = matchTitle && matchLevel && matchCat && matchSem;
            card.style.display = show ? '' : 'none';
          });
        }

        [search, levelSel, catSel, semesterSel].forEach(function(el){ if (el) el.addEventListener('input', filterCards); });
        if (resetBtn) resetBtn.addEventListener('click', function(){
          if (search) search.value = '';
          if (levelSel) levelSel.value = '';
          if (catSel) catSel.value = '';
          if (semesterSel) semesterSel.value = '';
          filterCards();
        });
      })();
    </script>

    <!-- Preview modal (iframe) -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="previewTitle">Preview</h5>
            <div class="ms-2">
              <a id="previewOpenLink" class="btn btn-sm btn-outline-primary me-2" href="#" target="_blank" rel="noopener">Open in new tab</a>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-0">
            <iframe id="previewFrame" src="" style="width:100%;height:75vh;border:0"></iframe>
          </div>
        </div>
      </div>
    </div>
</main>

<!-- Bootstrap JS bundle from CDN for interactive components (optional) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Initialize preview modal after Bootstrap has loaded
      (function(){
        const modalEl = document.getElementById('previewModal');
        if (!modalEl) return;
        const previewFrame = document.getElementById('previewFrame');
        const previewTitle = document.getElementById('previewTitle');
        const bsModal = new bootstrap.Modal(modalEl);

        const previewOpenLink = document.getElementById('previewOpenLink');
        document.querySelectorAll('.preview-btn').forEach(function(btn){
          btn.addEventListener('click', function(){
            const url = this.getAttribute('data-preview-url');
            const pageUrl = this.getAttribute('data-preview-page-url') || url;
            const title = this.getAttribute('data-title') || 'Preview';
            previewTitle.textContent = title;
            previewFrame.src = url;
            if (previewOpenLink) previewOpenLink.href = pageUrl;
            bsModal.show();
          });
        });

        modalEl.addEventListener('hidden.bs.modal', function(){
          previewFrame.src = '';
        });
      })();
    </script>
</body>
</html>
